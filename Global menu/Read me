The code is not completely clean yet, but works for almost everything.
